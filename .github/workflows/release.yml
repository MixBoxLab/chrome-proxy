name: Release to Chrome Web Store

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Update manifest version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        echo "Setting version to: $VERSION"
        
        # Update manifest.json version
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" manifest.json
        
        # Verify the change
        grep "version" manifest.json
        
    - name: Create extension package
      run: |
        # Create build directory
        mkdir -p build
        
        # Copy all necessary files
        cp manifest.json build/
        cp background.js build/
        cp -r popup build/
        cp -r icons build/
        
        # Create zip file
        cd build
        zip -r ../extension.zip .
        cd ..
        
        echo "Extension package created: extension.zip"
        ls -la extension.zip
        
    - name: Verify package contents
      run: |
        echo "Package contents:"
        unzip -l extension.zip
        
    # æš‚æ—¶ç¦ç”¨è‡ªåŠ¨ä¸Šä¼ ï¼Œç­‰å¾… Google éªŒè¯å®Œæˆ
    # - name: Upload to Chrome Web Store
    #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    #   uses: mnao305/chrome-extension-upload@v5.0.0
    #   with:
    #     file-path: extension.zip
    #     extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
    #     client-id: ${{ secrets.CHROME_CLIENT_ID }}
    #     client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
    #     refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
    #     publish: true
    
    - name: Manual Upload Instructions
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      run: |
        echo "## âš ï¸  æ‰‹åŠ¨ä¸Šä¼ è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ç”±äºŽ Google éªŒè¯æµç¨‹å°šæœªå®Œæˆï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ åˆ° Chrome Web Storeï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. ä¸‹è½½ä¸Šæ–¹ç”Ÿæˆçš„ \`extension.zip\` æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "2. è®¿é—® [Chrome Web Store Developer Dashboard](https://chrome.google.com/webstore/devconsole)" >> $GITHUB_STEP_SUMMARY
        echo "3. é€‰æ‹©ä½ çš„æ‰©å±•ç¨‹åº" >> $GITHUB_STEP_SUMMARY
        echo "4. ç‚¹å‡» 'ä¸Šä¼ æ–°ç‰ˆæœ¬'" >> $GITHUB_STEP_SUMMARY
        echo "5. é€‰æ‹©ä¸‹è½½çš„ zip æ–‡ä»¶å¹¶æäº¤å®¡æ ¸" >> $GITHUB_STEP_SUMMARY
        
    - name: Create GitHub Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: extension.zip
        generate_release_notes: true
        body: |
          ## ðŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          è¿™ä¸ªç‰ˆæœ¬åŒ…å«ä»¥ä¸‹æ”¹è¿›ï¼š
          - ðŸ› Bug ä¿®å¤å’Œæ€§èƒ½ä¼˜åŒ–
          - âœ¨ æ–°åŠŸèƒ½å’Œæ”¹è¿›
          - ðŸ“š æ–‡æ¡£æ›´æ–°
          
          ### å®‰è£…æ–¹æ³•
          
          1. **Chrome Web Storeï¼ˆæŽ¨èï¼‰**ï¼š
             - ç­‰å¾…å®¡æ ¸é€šè¿‡åŽï¼Œç›´æŽ¥ä»Žå•†åº—å®‰è£…
          
          2. **æ‰‹åŠ¨å®‰è£…**ï¼š
             - ä¸‹è½½ä¸‹æ–¹çš„ `extension.zip` æ–‡ä»¶
             - è§£åŽ‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
             - åœ¨ Chrome ä¸­æ‰“å¼€ \`chrome://extensions/\`
             - å¼€å¯"å¼€å‘è€…æ¨¡å¼"
             - ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
             - é€‰æ‹©è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹
          
          ### æ›´æ–°æ—¥å¿—
          
          æŸ¥çœ‹å®Œæ•´çš„æ›´æ–°æ—¥å¿—è¯·å‚è€ƒ [commits](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Workflow summary
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        
        echo "## ðŸŽ‰ æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç‰ˆæœ¬**: $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "**æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ äº§ç‰©" >> $GITHUB_STEP_SUMMARY
        echo "- extension.zip ($(ls -lh extension.zip | awk '{print $5}'))" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "- âœ… å·²è‡ªåŠ¨ä¸Šä¼ åˆ° Chrome Web Store" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å·²åˆ›å»º GitHub Release" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â³ æ‰‹åŠ¨è§¦å‘çš„æž„å»ºï¼Œæœªè‡ªåŠ¨å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¡ åˆ›å»º tag æŽ¨é€æ¥è§¦å‘è‡ªåŠ¨å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
        fi
